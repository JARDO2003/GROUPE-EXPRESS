<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#667eea">
    <title>GROUPE EXPRESS - Notifications</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            padding: 40px 20px;
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .logo {
            width: 80px;
            height: 80px;
            background: white;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 2rem;
            font-weight: 800;
            color: #667eea;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .btn {
            width: 100%;
            padding: 18px;
            border: none;
            border-radius: 14px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
            margin-top: 10px;
        }

        .status {
            padding: 20px;
            border-radius: 14px;
            margin-bottom: 20px;
            text-align: center;
            display: none;
        }

        .status.active {
            display: block;
            background: #d1fae5;
            color: #065f46;
        }

        .status.error {
            display: block;
            background: #fee2e2;
            color: #991b1b;
        }

        .token-box {
            background: #1f2937;
            color: #10b981;
            padding: 15px;
            border-radius: 12px;
            font-family: monospace;
            font-size: 0.75rem;
            word-break: break-all;
            margin-top: 15px;
            position: relative;
            display: none;
            max-height: 150px;
            overflow-y: auto;
        }

        .token-box.show {
            display: block;
        }

        .copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #374151;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.75rem;
        }

        .notification-item {
            background: #f9fafb;
            border-left: 4px solid #667eea;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .notification-time {
            font-size: 0.75rem;
            color: #6b7280;
        }

        .notification-title {
            font-weight: 700;
            margin: 5px 0;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #9ca3af;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #1f2937;
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            transition: transform 0.3s;
            z-index: 1000;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .info-box {
            background: #dbeafe;
            border: 1px solid #3b82f6;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            color: #1e40af;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">GE</div>
            <h1>GROUPE EXPRESS</h1>
            <p>Notifications Firebase Cloud Messaging</p>
        </div>

        <div class="card">
            <div class="info-box">
                <strong>FCM :</strong> Notifications fiables sur tous les appareils.
            </div>

            <div class="status" id="status-box">
                <div style="font-size: 2rem; margin-bottom: 10px;">‚úì</div>
                <div style="font-weight: 700;">Notifications activees !</div>
                <div style="font-size: 0.9rem; margin-top: 5px;">Token genere avec succes</div>
            </div>

            <button class="btn btn-primary" id="subscribe-btn" onclick="subscribeToFCM()">
                <span id="btn-text">Activer les notifications</span>
            </button>

            <div class="token-box" id="token-box">
                <button class="copy-btn" onclick="copyToken()">Copier</button>
                <div id="token-content"></div>
            </div>

            <button class="btn btn-secondary" onclick="sendTestToLuna()" style="display: none;" id="luna-btn">
                Envoyer a Luna
            </button>
        </div>

        <div class="card">
            <h2 style="margin-bottom: 20px;">Messages recus</h2>
            <div id="notifications-list">
                <div class="empty-state">
                    <p>Aucune notification</p>
                </div>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <!-- Firebase SDK COMPAT -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-messaging-compat.js"></script>

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        
        const firebaseConfig = {
            apiKey: "AIzaSyBsGrY-AqYMoI70kT3WMxLgW0HwYA4KyaQ",
            authDomain: "livraison-c8498.firebaseapp.com",
            projectId: "livraison-c8498",
            storageBucket: "livraison-c8498.firebasestorage.app",
            messagingSenderId: "403240604780",
            appId: "1:403240604780:web:77d84ad03d68bdaddfb449"
        };

        const VAPID_KEY = "PViQXia_vvFLKMAe2E2q5oTOX48XpRQIdx5P4xAFEPw";

        // ============================================
        // INITIALISATION
        // ============================================
        
        let messaging = null;
        let currentToken = null;

        // Initialiser Firebase
        try {
            firebase.initializeApp(firebaseConfig);
            messaging = firebase.messaging();
            console.log("‚úÖ Firebase initialise");
        } catch (error) {
            console.error("‚ùå Erreur Firebase:", error);
            showToast("Erreur d'initialisation", "error");
        }

        // ============================================
        // SERVICE WORKER (SANS useServiceWorker)
        // ============================================

        // Le SW doit etre enregistre mais PAS attache manuellement a FCM
        // FCM le trouve automatiquement s'il est a la racine
        if ("serviceWorker" in navigator) {
            navigator.serviceWorker.register("./firebase-messaging-sw.js")
                .then((registration) => {
                    console.log("‚úÖ Service Worker enregistre:", registration.scope);
                    checkExistingToken();
                })
                .catch((err) => {
                    console.error("‚ùå Erreur SW:", err);
                    showToast("Erreur Service Worker", "error");
                });
        }

        // ============================================
        // FONCTIONS PRINCIPALES
        // ============================================

        function checkExistingToken() {
            const savedToken = localStorage.getItem("fcmToken");
            if (savedToken) {
                currentToken = savedToken;
                document.getElementById("token-content").textContent = savedToken;
                document.getElementById("token-box").classList.add("show");
                showActive();
            }
        }

        async function subscribeToFCM() {
            const btn = document.getElementById("subscribe-btn");
            const btnText = document.getElementById("btn-text");
            
            btn.disabled = true;
            btnText.innerHTML = '<span class="loading"></span> Chargement...';

            try {
                // 1. Permission
                if (!("Notification" in window)) {
                    throw new Error("Notifications non supportees");
                }

                const permission = await Notification.requestPermission();
                if (permission !== "granted") {
                    throw new Error("Permission refusee");
                }

                // 2. Obtenir token (FCM trouve automatiquement le SW)
                console.log("üîë Obtention du token...");
                currentToken = await messaging.getToken({
                    vapidKey: VAPID_KEY
                    // PAS de serviceWorkerRegistration ici !
                    // FCM trouve automatiquement firebase-messaging-sw.js a la racine
                });
                
                if (!currentToken) {
                    throw new Error("Token vide - verifiez la configuration Firebase");
                }

                console.log("‚úÖ Token obtenu:", currentToken);

                // 3. Afficher
                document.getElementById("token-content").textContent = currentToken;
                document.getElementById("token-box").classList.add("show");
                localStorage.setItem("fcmToken", currentToken);

                // 4. Ecouter messages premier plan
                messaging.onMessage((payload) => {
                    console.log("üì® Message recu:", payload);
                    displayNotification(payload.notification);
                    showToast("Nouvelle notification !");
                });

                showActive();
                showToast("‚úÖ Notifications activees !");

            } catch (error) {
                console.error("‚ùå Erreur:", error);
                showError(error.message);
                btn.disabled = false;
                btnText.textContent = "Reessayer";
            }
        }

        function displayNotification(notification) {
            const list = document.getElementById("notifications-list");
            const empty = list.querySelector(".empty-state");
            if (empty) empty.remove();

            const div = document.createElement("div");
            div.className = "notification-item";
            div.innerHTML = `
                <div class="notification-time">${new Date().toLocaleString("fr-FR")}</div>
                <div class="notification-title">${notification?.title || "Message"}</div>
                <div>${notification?.body || ""}</div>
            `;
            
            list.insertBefore(div, list.firstChild);
        }

        function showActive() {
            document.getElementById("status-box").className = "status active";
            document.getElementById("subscribe-btn").style.display = "none";
            document.getElementById("luna-btn").style.display = "block";
        }

        function showError(msg) {
            const status = document.getElementById("status-box");
            status.className = "status error";
            status.innerHTML = `
                <div style="font-size: 2rem;">‚úó</div>
                <div style="font-weight: 700;">Erreur</div>
                <div style="font-size: 0.9rem; margin-top: 5px;">${msg}</div>
            `;
        }

        function copyToken() {
            if (!currentToken) return;
            navigator.clipboard.writeText(currentToken).then(() => {
                showToast("‚úÖ Token copie !");
            });
        }

        function sendTestToLuna() {
            if (!currentToken) return;
            window.open("luna.html?token=" + encodeURIComponent(currentToken), "_blank");
        }

        function showToast(msg, type = "success") {
            const toast = document.getElementById("toast");
            toast.textContent = msg;
            toast.style.background = type === "error" ? "#ef4444" : "#1f2937";
            toast.classList.add("show");
            setTimeout(() => toast.classList.remove("show"), 4000);
        }
    </script>
</body>
</html>
